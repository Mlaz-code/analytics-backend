name: Backend CI/CD

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  PYTHON_VERSION: "3.12"

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt || echo "No root requirements.txt"
          cd mlops && pip install -r requirements.txt

      - name: Run MLOps tests
        run: |
          cd mlops
          pytest tests/ -v --cov=app --cov-report=xml --cov-report=html
        env:
          ENVIRONMENT: test
          MODEL_DIR: /tmp/test_models

      - name: Upload coverage reports
        uses: codecov/codecov-action@v4
        with:
          files: ./mlops/coverage.xml
          flags: mlops
          name: mlops-coverage
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'

  lint:
    name: Code Quality
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install linting tools
        run: |
          pip install flake8 black isort mypy

      - name: Run flake8
        run: |
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
          flake8 . --count --max-line-length=127 --statistics
        continue-on-error: true

      - name: Check black formatting
        run: |
          black --check --diff .
        continue-on-error: true

      - name: Check isort
        run: |
          isort --check-only --diff .
        continue-on-error: true

  validate-openapi:
    name: Validate OpenAPI Contract
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' || (github.event_name == 'push' && github.ref == 'refs/heads/main')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate OpenAPI spec
        uses: char0n/swagger-editor-validate@v1
        with:
          definition-file: openapi.yaml
        if: hashFiles('openapi.yaml') != ''

      - name: Check for OpenAPI spec
        run: |
          if [ ! -f "openapi.yaml" ]; then
            echo "âš ï¸ Warning: openapi.yaml not found. Create it to enable contract validation."
            exit 0
          fi

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install bandit
        run: pip install bandit[toml]

      - name: Run security scan
        run: |
          bandit -r . -ll -f json -o bandit-report.json || true
          bandit -r . -ll
        continue-on-error: true

      - name: Upload security scan results
        uses: actions/upload-artifact@v4
        with:
          name: security-scan
          path: bandit-report.json
        if: always()

  build-docker:
    name: Build Docker Images
    runs-on: ubuntu-latest
    needs: [test, lint]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build ML API Docker image
        run: |
          cd mlops
          docker build -t pikkit-ml-api:${{ github.sha }} .
          docker build -t pikkit-ml-api:latest .

      - name: Test Docker image
        run: |
          docker run --rm pikkit-ml-api:latest python -c "import app.main; print('âœ… Import successful')"

      - name: Save Docker image (optional - for artifacts)
        run: |
          docker save pikkit-ml-api:latest | gzip > pikkit-ml-api.tar.gz
        if: false  # Enable if you want to upload image as artifact

  notify:
    name: Notify on Failure
    runs-on: ubuntu-latest
    needs: [test, lint, validate-openapi, security-scan]
    if: failure() && github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - name: Send notification
        run: |
          echo "ðŸš¨ CI/CD pipeline failed for analytics-backend"
          echo "Branch: ${{ github.ref }}"
          echo "Commit: ${{ github.sha }}"
          echo "Author: ${{ github.actor }}"
          # Add Telegram/Slack notification here if desired
